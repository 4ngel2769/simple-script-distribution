# No HTTPS needed since Cloudflare handles it
{
	auto_https off
	admin 0.0.0.0:2019
}

:80 {
	root * /srv/scripts
	
	# Admin dashboard routing (must come first)
	handle /admin* {
		reverse_proxy admin-dashboard:8080
	}
	
	# Health check
	handle /health {
		header Content-Type "text/plain"
		respond "OK"
	}
	
	# Handle script requests with clean URLs
	@script_request {
		path_regexp script ^/([^/]+)/?$
	}
	
	# Try multiple file patterns and follow symlinks
	handle @script_request {
		# Set headers first
		header Content-Type "text/plain; charset=utf-8"
		header Cache-Control "no-cache, must-revalidate"
		header X-Content-Type-Options "nosniff"
		
		# Try the symlinked file first, then other patterns
		try_files {re.script.1} {re.script.1}.sh {re.script.1}/{re.script.1}.sh {re.script.1}/runme_{re.script.1}.sh
		
		file_server {
			# Follow symlinks
			follow_symlinks
		}
	}
	
	# Root page - serve static HTML
	handle / {
		try_files index.html
		file_server
	}
	
	# Hide sensitive files
	@hidden {
		path */.*
		path */.backups/*
	}
	handle @hidden {
		respond "Not Found" 404
	}
	
	# Fallback 404
	handle {
		header Content-Type "text/plain"
		respond "Script not found" 404
	}
	
	# Logging
	log {
		output stdout
		format console
		level DEBUG
	}
}